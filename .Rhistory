#     main = "Istogramma di selling_price (prezzo di vendita auto usate)",
#     xlab = "Selling Price",
#     ylab = "Densità",
#     breaks = 237
#     )
print(paste("Indice di asimmetria della variabile response selling_price:", skew(car$selling_price), sep = " "))
print(paste("Indice di curtosi della variabile response selling_price:", kurtosi(car$selling_price), sep = " "))
car %>% ggplot()+geom_histogram(aes(selling_price, ..density..), bins = 30, )+geom_density(aes(selling_price))+ggtitle('Istogramma del logaritmo di selling_price (prezzo di vendita auto usate)')+xlab('Selling Price')+ylab('Densità')+scale_x_log10()
print(paste("Indice di asimmetria della variabile response selling_price:", skew(log(car$selling_price)), sep = " "))
print(paste("Indice di curtosi della variabile response selling_price:", kurtosi(log(car$selling_price)), sep = " "))
summary(car_num)
#istogrammi
#par(mfrow=c(2,3))
#for (i in names(car_num)) {
#  hist(car_num[[i]], xlab = i, main = '')
#}
#par(mfrow=c(1,1))
#istogrammi
plot1 <- car_num %>% ggplot()+geom_histogram(aes(age, ..density..), bins=15)+geom_density(aes(age))+ylab('')
#print(plot1)
#plot2 <- car_num %>% ggplot()+geom_histogram(aes(km_driven, ..density..), bins=30#)+geom_density(aes(km_driven))+scale_x_continuous(labels = function(x) format(x, scientific #= T))+theme(axis.text.x = element_text(angle = 10))+ylab('')
plot2 <- car_num %>% ggplot()+geom_histogram(aes(km_driven, ..density..), bins=30)+geom_density(aes(km_driven))+scale_x_continuous(labels = function(x) format(x, scientific = F))+ylab('')
#plot3 <- car_num %>% ggplot()+geom_histogram(aes(seats, ..density..), bins=)+geom_density#(aes(seats))+ylab('')
#print(plot3)
plot4 <- car_num %>% ggplot()+geom_histogram(aes(engine_CC, ..density..), bins=30)+geom_density(aes(engine_CC))+ylab('')
#print(plot4)
plot5 <- car_num %>% ggplot()+geom_histogram(aes(max_power_bhp, ..density..), bins=25)+geom_density(aes(max_power_bhp))+ylab('')
#print(plot5)
grid.arrange(plot1, plot2, plot4, plot5, ncol = 2,
top = "Istogrammi delle distribuzioni delle variabili esplicative quantitative",
left = "Densità"
)
for (i in names(car_num)) {
if (i == 'selling_price'){
next
}
print(paste("Indice di asimmetria di Pearson di",i,":", skew(car_num[[i]]), sep = " "))
}
for (i in names(car_num)) {
if (i == 'selling_price'){
next
}
print(paste("Indice di curtosi di Pearson di",i,":", kurtosi(car_num[[i]]), sep = " "))
}
for (i in names(car_num)) {
if (i == 'selling_price'){
next
}
print(paste("Indice di asimmetria di",i,":", skew(log(car_num[[i]])), sep = " "))
}
for (i in names(car_num)) {
if (i == 'selling_price'){
next
}
print(paste("Indice di curtosi di Pearson di",i,":", kurtosi(log(car_num[[i]])), sep = " "))
}
#istogrammi
#par(mfrow=c(2,3))
#for (i in c('year','selling_price','km_driven','engine(CC)','max_power(bhp)')) {
#  hist(log(car_num[[i]]), xlab = i, main = '')
#}
#par(mfrow=c(1,1))
plot1 <- car_num %>% ggplot()+geom_histogram(aes(age, ..density..), bins=15)+geom_density(aes(age))+ylab('')+scale_x_log10()
#print(plot1)
plot2 <- car_num %>% ggplot()+geom_histogram(aes(km_driven, ..density..), bins=30)+geom_density(aes(km_driven))+theme(axis.text.x = element_text(angle = 10))+ylab('')+scale_x_log10()
#plot3 <- car_num %>% ggplot()+geom_histogram(aes(seats, ..density..), bins=)+geom_density#(aes(seats))+ylab('')+scale_x_log10()
#print(plot3)
plot4 <- car_num %>% ggplot()+geom_histogram(aes(engine_CC, ..density..), bins=30)+geom_density(aes(engine_CC))+ylab('')+scale_x_log10()
#print(plot4)
plot5 <- car_num %>% ggplot()+geom_histogram(aes(max_power_bhp, ..density..), bins=30)+geom_density(aes(max_power_bhp))+ylab('')+scale_x_log10()
#print(plot5)
grid.arrange(plot1, plot2, plot4, plot5, ncol = 2,
top = "Istogrammi delle distribuzioni delle variabili esplicative quantitative \n dopo l'applicazione della trasformazione logaritmica",
left = "Densità"
)
car <- add_column(car, log_selling_price = log(car$selling_price), .after = "selling_price")
car <- add_column(car, log_age = log(car$age), .after = "age")
car <- add_column(car, log_max_power_bhp = log(car$max_power_bhp), .after = "max_power_bhp")
car <- add_column(car, log_engine_CC = log(car$engine_CC), .after = "engine_CC")
car_num <- add_column(car_num, log_selling_price = log(car_num$selling_price), .after = "selling_price")
car_num <- add_column(car_num, log_age = log(car_num$age), .after = "age")
car_num <- add_column(car_num, log_max_power_bhp = log(car_num$max_power_bhp), .after = "max_power_bhp")
car_num <- add_column(car_num, log_engine_CC = log(car_num$engine_CC), .after = "engine_CC")
# coef = 3 indica la lunghezza dei baffi come multipli dell'IQR (porto da 1.5 a 4)
p <- car %>% ggplot(aes(fuel, log_selling_price))+geom_boxplot(coef = 3)+geom_jitter(alpha=0.05)+theme(axis.text.x = element_text(angle = 0, hjust = 1))+stat_summary(fun.y=mean, geom="point", shape=20, size=3, color="red", fill="red")
print(p)
corRatio(car$log_selling_price, car$fuel)
chisq_price_fuel <- chisq.test(car$log_selling_price, car$fuel, simulate.p.value = TRUE)
chisq_price_fuel$statistic
p1 <- car %>% ggplot(aes(owner, log_selling_price))+geom_boxplot(coef = 3)+geom_jitter(alpha=0.05)+theme(axis.text.x = element_text(angle = 0, hjust = 1))+stat_summary(fun.y=mean, geom="point", shape=20, size=3, color="red", fill="red")+theme(axis.text.x = element_text(angle = 20, hjust = 1))
print(p1)
corRatio(car$log_selling_price, car$owner)
chisq_price_owner <- chisq.test(car$log_selling_price, car$owner, simulate.p.value = TRUE)
chisq_price_owner$statistic
car %>% group_by(make) %>% count() %>% arrange(desc(n)) %>% ggplot() + geom_col(aes(x=n,y=reorder(make,n)), show.legend = F)+
labs(title = 'Distribuzione marche di auto ordinate per frequenza assoluta',
subtitle = '',
x= 'Frequenza Assoluta',
y='make')
car %>% ggplot(aes(reorder(make, selling_price, median), selling_price))+geom_boxplot()+geom_jitter(alpha=0.02)+geom_hline(aes(yintercept=median(selling_price)))+coord_flip()+xlab('make (marche ordinate per prezzo mediano)')+ylab('selling_price')+theme(aspect.ratio=1)+scale_y_log10()
car %>% ggplot(aes(transmission, log_selling_price))+geom_boxplot(coef = 3)+geom_jitter(alpha=0.05)+theme(axis.text.x = element_text(angle = 0, hjust = 1))+stat_summary(fun.y=mean, geom="point", shape=20, size=3, color="red", fill="red")
corRatio(car$log_selling_price, car$transmission)
chisq_price_transmission <- chisq.test(car$log_selling_price, car$transmission, simulate.p.value = TRUE)
chisq_price_transmission$statistic
car %>% ggplot(aes(seller_type, log_selling_price))+geom_boxplot(coef = 3)+geom_jitter(alpha=0.05)+theme(axis.text.x = element_text(angle = 0, hjust = 1))+stat_summary(fun.y=mean, geom="point", shape=20, size=3, color="red", fill="red")
corRatio(car$log_selling_price, car$seller_type)
chisq_price_seller_type <- chisq.test(car$log_selling_price, car$seller_type, simulate.p.value = TRUE)
chisq_price_transmission$statistic
# Aggiorno il vettore delle colonne numeriche di car
car_nums_colnames_log <- c('log_age','log_selling_price','km_driven','log_engine_CC','log_max_power_bhp', 'seats')
# Prendo un campione di osservazioni per rendere più agile la rappresentazione grafica:
leggero <- car[sample(nrow(car), 500), ]
# Matrice dei diagrammi di dispersione: (non serve usare le variabili trasformate perchè la correlazione non cambia)
pairs(leggero[, car_nums_colnames_log])
cor(car[ ,car_nums_colnames_log])
ggcorr(car[,car_nums_colnames_log], label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
#T TEST
#Variable importance
#F TEST
#Adjusted R-squared                 quanto bene il modello descrive i dati
#Residual analysis
#(compare two models with anova)
#Prediction RMSE
car_dummy <- car[,car_nums_colnames_log]
car_dummy <- select(car_dummy, -c('seats', 'log_engine_CC', 'km_driven'))
# Aggiungo la variabile fattoriale 'transmission' a car dummy e la converto in numerica (0 corrispode a 'automatic'):
car_dummy <- cbind(car_dummy,transmission = car$transmission)
levels(car_dummy$transmission)<-c(1,0)
car_dummy$transmission <- as.numeric(levels(car_dummy$transmission))[car_dummy$transmission]
#converto la variabile fattoriale 'make' in dummy e la aggiungo a car_dummy:
dummy_temp <- data.frame(model.matrix( ~make, data = car))[,-1]
car_dummy <-cbind(car_dummy,dummy_temp)
#converto la variabile fattoriale 'fuel' in dummy e la aggiungo a car_dummy:
dummy_temp <- data.frame(model.matrix( ~fuel, data = car))[,-1]
car_dummy <-cbind(car_dummy,dummy_temp)
#converto la variabile fattoriale 'seller_type' in dummy e la aggiungo a car_dummy:
dummy_temp <- data.frame(model.matrix( ~seller_type, data = car))[,-1]
car_dummy <-cbind(car_dummy,dummy_temp)
#converto la variabile fattoriale 'owner' in dummy e la aggiungo a car_dummy:
dummy_temp <- data.frame(model.matrix( ~owner, data = car))[,-1]
car_dummy <-cbind(car_dummy,dummy_temp)
head(car_dummy)
sum(duplicated(car_dummy))
sum(duplicated(car))
car_dummy <- car_dummy[!duplicated(car_dummy),]
set.seed(100)
train_ind<-sample(1:nrow(car_dummy),0.8*nrow(car_dummy))
train_set <- car_dummy[train_ind,]
test_set <- car_dummy[-train_ind,]
print(paste("Numero righe train_set:", nrow(train_set), sep = " "))
print(paste("Numero righe test_set: ", nrow(test_set), sep = " "))
modello_completo <- lm(log_selling_price ~ ., data=train_set)
summary(modello_completo)
par(pty="s")
plot(modello_completo)
modello_minimo <- lm(log_selling_price ~ log_max_power_bhp, data=train_set)
summary(modello_minimo)
ggplot(train_set, aes(x = log_max_power_bhp, y = log_selling_price)) + geom_point() + stat_smooth(method = "lm", col = "red")
modello_stepAIC <- stepAIC(modello_minimo, direction = "forward", scope = formula(modello_completo))
summary(modello_stepAIC)
par(pty="s")
plot(modello_stepAIC)
k_value <- qchisq(0.001, 1, lower.tail = F)
modello_stepAIC_k <- stepAIC(modello_minimo, direction = "forward", scope = formula(modello_completo), k = k_value)
summary(modello_stepAIC_k)
par(pty="s")
plot(modello_stepAIC_k)
anova(modello_stepAIC, modello_stepAIC_k)
lm_pred <- predict(modello_stepAIC, newdata = test_set %>% select(-selling_price))
lm_pred <- predict(modello_stepAIC, newdata = test_set %>% select(-log_selling_price))
# RMSE of train dataset
RMSE(pred = modello_stepAIC$fitted.values, obs = train_set$log_selling_price)
lm_pred <- predict(modello_stepAIC, newdata = test_set %>% select(-log_selling_price))
# RMSE del train dataset
RMSE(pred = modello_stepAIC$fitted.values, obs = train_set$log_selling_price)
# RMSE del test dataset
RMSE(pred = modello_stepAIC, obs = test_set$log_selling_price)
# RMSE del test dataset
RMSE(pred = modello_stepAIC, obs = test_set$log_selling_price)
# RMSE del train dataset
RMSE(pred = modello_stepAIC$fitted.values, obs = train_set$log_selling_price)
# RMSE del test dataset
RMSE(pred = modello_stepAIC, obs = test_set$log_selling_price)
# RMSE del test dataset
RMSE(pred = modello_stepAIC, obs = test_set$log_selling_price)
lm_pred2 <- predict(modello_stepAIC_k, newdata = test_set %>% select(-log_selling_price))
# RMSE del train dataset
RMSE(pred = modello_stepAIC_k$fitted.values, obs = train_set$log_selling_price)
# RMSE del test dataset
RMSE(pred = modello_stepAIC_k, obs = test_set$log_selling_price)
set.seed(100)
train_ind<-sample(1:nrow(car_dummy),0.8*nrow(car_dummy))
train_set <- car_dummy[train_ind,]
test_set <- car_dummy[-train_ind,]
lm_pred <- predict(modello_stepAIC, newdata = test_set %>% select(-log_selling_price))
# RMSE del train dataset
RMSE(pred = modello_stepAIC$fitted.values, obs = train_set$log_selling_price)
# RMSE del test dataset
RMSE(pred = modello_stepAIC, obs = test_set$log_selling_price)
# RMSE del test dataset
RMSE(predictions, test_set$log_selling_price)
# RMSE del test dataset
RMSE(modello_stepAIC, test_set$log_selling_price)
R2(modello_stepAIC, test_set$log_selling_price)
View(test_set)
View(train_set)
lm_pred <- predict(modello_stepAIC, newdata = test_set %>% select(-log_selling_price))
# RMSE of train dataset
RMSE(pred = car_lm$fitted.values, obs = data_train$price)
lm_pred <- predict(modello_stepAIC, newdata = test_set %>% select(-log_selling_price))
# RMSE of train dataset
RMSE(pred = modello_stepAIC$fitted.values, obs = train_set$log_selling_price)
# RMSE of test dataset
RMSE(pred = lm_pred, obs = test_set$log_selling_price)
lm_pred <- predict(modello_stepAIC, newdata = test_set %>% select(-log_selling_price))
# RMSE of train dataset
RMSE(pred = modello_stepAIC$fitted.values, obs = train_set$log_selling_price)
# RMSE of test dataset
RMSE(pred = lm_pred, obs = test_set$log_selling_price)
lm_pred2 <- predict(modello_stepAIC_k, newdata = test_set %>% select(-log_selling_price))
# RMSE of train dataset
RMSE(pred = modello_stepAIC_k$fitted.values, obs = train_set$log_selling_price)
# RMSE of test dataset
RMSE(pred = lm_pred2, obs = test_set$log_selling_price)
ggcorr(modello_stepAIC, label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
ggcorr(modello_stepAIC, label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
ggcorr(modello_stepAIC_k, label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
modello_stepAIC<- modello_stepAIC %>% mutate_if(~is.character(.), ~as.factor(.))
ggcorr(modello_stepAIC[,modello_stepAIC_nums_colnames_log], label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
ggcorr(modello_stepAIC, label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
ggcorr(modello_stepAIC_k, label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
ggcorr(lm(modello_stepAIC, label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2))
ggcorr(lm(modello_stepAIC), label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
View(modello_minimo)
View(modello_stepAIC)
View(modello_stepAIC_k)
cor(modello_stepAIC)
modello_stepAIC<- data.frame(x1=rnorm(10),
x2=rnorm(10),
x3=rnorm(10))
cor(modello_stepAIC)
View(modello_stepAIC)
View(modello_stepAIC_k)
View(modello_minimo)
View(modello_completo)
View(modello_completo)
View(modello_stepAIC)
View(modello_stepAIC_k)
modello_stepAIC_k<- data.frame(x1=rnorm(10),
x2=rnorm(10),
x3=rnorm(10))
cor(modello_stepAIC_k)
View(modello_stepAIC_k)
ggcorr(modello_stepAIC, label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
library(MASS)
library(readr)
library(tibble)
library(dplyr)
library(stringr)
library(mice)
library(caret)
library(ggcorrplot)
library(GGally) #Per il ggcorr()
library(DiscriMiner) # Per il correlation ratio
library(psych)
library(ggrepel)
library(gridExtra)
library(glmnet)
library(xgboost)
data_path <- "https://raw.githubusercontent.com/giocoal/datasets/main/Car%20details%20v3.csv"
car <- read_csv(data_path, col_types = 'ciiiffff????i')
head(data.frame(car))
#View(car)
car <- select(car, -c(torque,mileage))
head(car)
car$selling_price <- car$selling_price*0.01
car <- add_column(car, age = 2021 - car$year, .after = "year")
car <- select(car, -c("year"))
car$max_power[car$max_power == 0 | car$max_power == "bhp"] <- NA
all(grepl("CC", car$engine) == !is.na(car$engine))
#viene TRUE quindi sono tutti consistenti
all((grepl("bhp", car$max_power)) == !is.na(car$max_power))
#viene TRUE quindi sono tutti consistenti
car['engine_CC'] <- parse_number(car$engine)
car['max_power_bhp'] <- parse_number(car$max_power)
car <- select(car, -c('engine', 'max_power'))
car <- add_column(car, make = factor(word(car$name, 1)), .after = "name")
# md.pattern (del pacchetto mice), è una funzione di visualizzazione molto utile
# Permette di vedere la distribuzione di NA nel dataset
md.pattern(car, rotate.names=TRUE)
#numero di righe con almeno un NA (coincide con quanto visto in md.pattern)
# sum(!complete.cases(car))
car <- car[-which(!complete.cases(car)),]
car_nums_colnames <- unlist(lapply(car, is.numeric))
car_num <- car[ , car_nums_colnames]
car_num <- select(car_num, -c('seats'))
summary(car_num)
par(mfrow=c(2,3))
#summary(car_num)
for (i in names(car_num)) {
boxplot(car_num[[i]], xlab = i, main = '')
}
par(mfrow=c(1,1))
par(mfrow=c(2,3))
for (i in names(car_num)) {
boxplot(log(car_num[[i]]), main = '', xlab = i, range = 3)
}
par(mfrow=c(1,1))
car_num <- car_num[car_num$selling_price < 80000, ]
car_num <- car_num[car_num$engine_CC < 3000, ]
car_num <- car_num[car_num$max_power_bhp < 300, ]
car_num <- car_num[car_num$km_driven < 300000 & car_num$km_driven > 1, ]
car <- car[car$selling_price < 80000, ]
car <- car[car$engine_CC < 3000, ]
car <- car[car$max_power_bhp < 300, ]
car <- car[car$km_driven < 300000 & car$km_driven > 1, ]
#str(car, give.attr = F)
summary(car)
#class(car)
#dim(car)
summary(car$selling_price)
car %>% ggplot()+geom_histogram(aes(selling_price, ..density..), bins = 30, )+geom_density(aes(selling_price))+ggtitle('Istogramma di selling_price (prezzo di vendita auto usate)')+xlab('Selling Price')+ylab('Densità')
#hist(car$selling_price,
#     freq = F,
#     main = "Istogramma di selling_price (prezzo di vendita auto usate)",
#     xlab = "Selling Price",
#     ylab = "Densità",
#     breaks = 237
#     )
print(paste("Indice di asimmetria della variabile response selling_price:", skew(car$selling_price), sep = " "))
print(paste("Indice di curtosi della variabile response selling_price:", kurtosi(car$selling_price), sep = " "))
car %>% ggplot()+geom_histogram(aes(selling_price, ..density..), bins = 30, )+geom_density(aes(selling_price))+ggtitle('Istogramma del logaritmo di selling_price (prezzo di vendita auto usate)')+xlab('Selling Price')+ylab('Densità')+scale_x_log10()
print(paste("Indice di asimmetria della variabile response selling_price:", skew(log(car$selling_price)), sep = " "))
print(paste("Indice di curtosi della variabile response selling_price:", kurtosi(log(car$selling_price)), sep = " "))
summary(car_num)
#istogrammi
#par(mfrow=c(2,3))
#for (i in names(car_num)) {
#  hist(car_num[[i]], xlab = i, main = '')
#}
#par(mfrow=c(1,1))
#istogrammi
plot1 <- car_num %>% ggplot()+geom_histogram(aes(age, ..density..), bins=15)+geom_density(aes(age))+ylab('')
#print(plot1)
#plot2 <- car_num %>% ggplot()+geom_histogram(aes(km_driven, ..density..), bins=30#)+geom_density(aes(km_driven))+scale_x_continuous(labels = function(x) format(x, scientific #= T))+theme(axis.text.x = element_text(angle = 10))+ylab('')
plot2 <- car_num %>% ggplot()+geom_histogram(aes(km_driven, ..density..), bins=30)+geom_density(aes(km_driven))+scale_x_continuous(labels = function(x) format(x, scientific = F))+ylab('')
#plot3 <- car_num %>% ggplot()+geom_histogram(aes(seats, ..density..), bins=)+geom_density#(aes(seats))+ylab('')
#print(plot3)
plot4 <- car_num %>% ggplot()+geom_histogram(aes(engine_CC, ..density..), bins=30)+geom_density(aes(engine_CC))+ylab('')
#print(plot4)
plot5 <- car_num %>% ggplot()+geom_histogram(aes(max_power_bhp, ..density..), bins=25)+geom_density(aes(max_power_bhp))+ylab('')
#print(plot5)
grid.arrange(plot1, plot2, plot4, plot5, ncol = 2,
top = "Istogrammi delle distribuzioni delle variabili esplicative quantitative",
left = "Densità"
)
for (i in names(car_num)) {
if (i == 'selling_price'){
next
}
print(paste("Indice di asimmetria di Pearson di",i,":", skew(car_num[[i]]), sep = " "))
}
for (i in names(car_num)) {
if (i == 'selling_price'){
next
}
print(paste("Indice di curtosi di Pearson di",i,":", kurtosi(car_num[[i]]), sep = " "))
}
for (i in names(car_num)) {
if (i == 'selling_price'){
next
}
print(paste("Indice di asimmetria di",i,":", skew(log(car_num[[i]])), sep = " "))
}
for (i in names(car_num)) {
if (i == 'selling_price'){
next
}
print(paste("Indice di curtosi di Pearson di",i,":", kurtosi(log(car_num[[i]])), sep = " "))
}
#istogrammi
#par(mfrow=c(2,3))
#for (i in c('year','selling_price','km_driven','engine(CC)','max_power(bhp)')) {
#  hist(log(car_num[[i]]), xlab = i, main = '')
#}
#par(mfrow=c(1,1))
plot1 <- car_num %>% ggplot()+geom_histogram(aes(age, ..density..), bins=15)+geom_density(aes(age))+ylab('')+scale_x_log10()
#print(plot1)
plot2 <- car_num %>% ggplot()+geom_histogram(aes(km_driven, ..density..), bins=30)+geom_density(aes(km_driven))+theme(axis.text.x = element_text(angle = 10))+ylab('')+scale_x_log10()
#plot3 <- car_num %>% ggplot()+geom_histogram(aes(seats, ..density..), bins=)+geom_density#(aes(seats))+ylab('')+scale_x_log10()
#print(plot3)
plot4 <- car_num %>% ggplot()+geom_histogram(aes(engine_CC, ..density..), bins=30)+geom_density(aes(engine_CC))+ylab('')+scale_x_log10()
#print(plot4)
plot5 <- car_num %>% ggplot()+geom_histogram(aes(max_power_bhp, ..density..), bins=30)+geom_density(aes(max_power_bhp))+ylab('')+scale_x_log10()
#print(plot5)
grid.arrange(plot1, plot2, plot4, plot5, ncol = 2,
top = "Istogrammi delle distribuzioni delle variabili esplicative quantitative \n dopo l'applicazione della trasformazione logaritmica",
left = "Densità"
)
car <- add_column(car, log_selling_price = log(car$selling_price), .after = "selling_price")
car <- add_column(car, log_age = log(car$age), .after = "age")
car <- add_column(car, log_max_power_bhp = log(car$max_power_bhp), .after = "max_power_bhp")
car <- add_column(car, log_engine_CC = log(car$engine_CC), .after = "engine_CC")
car_num <- add_column(car_num, log_selling_price = log(car_num$selling_price), .after = "selling_price")
car_num <- add_column(car_num, log_age = log(car_num$age), .after = "age")
car_num <- add_column(car_num, log_max_power_bhp = log(car_num$max_power_bhp), .after = "max_power_bhp")
car_num <- add_column(car_num, log_engine_CC = log(car_num$engine_CC), .after = "engine_CC")
# coef = 3 indica la lunghezza dei baffi come multipli dell'IQR (porto da 1.5 a 4)
p <- car %>% ggplot(aes(fuel, log_selling_price))+geom_boxplot(coef = 3)+geom_jitter(alpha=0.05)+theme(axis.text.x = element_text(angle = 0, hjust = 1))+stat_summary(fun.y=mean, geom="point", shape=20, size=3, color="red", fill="red")
print(p)
corRatio(car$log_selling_price, car$fuel)
chisq_price_fuel <- chisq.test(car$log_selling_price, car$fuel, simulate.p.value = TRUE)
chisq_price_fuel$statistic
p1 <- car %>% ggplot(aes(owner, log_selling_price))+geom_boxplot(coef = 3)+geom_jitter(alpha=0.05)+theme(axis.text.x = element_text(angle = 0, hjust = 1))+stat_summary(fun.y=mean, geom="point", shape=20, size=3, color="red", fill="red")+theme(axis.text.x = element_text(angle = 20, hjust = 1))
print(p1)
corRatio(car$log_selling_price, car$owner)
chisq_price_owner <- chisq.test(car$log_selling_price, car$owner, simulate.p.value = TRUE)
chisq_price_owner$statistic
car %>% group_by(make) %>% count() %>% arrange(desc(n)) %>% ggplot() + geom_col(aes(x=n,y=reorder(make,n)), show.legend = F)+
labs(title = 'Distribuzione marche di auto ordinate per frequenza assoluta',
subtitle = '',
x= 'Frequenza Assoluta',
y='make')
car %>% ggplot(aes(reorder(make, selling_price, median), selling_price))+geom_boxplot()+geom_jitter(alpha=0.02)+geom_hline(aes(yintercept=median(selling_price)))+coord_flip()+xlab('make (marche ordinate per prezzo mediano)')+ylab('selling_price')+theme(aspect.ratio=1)+scale_y_log10()
car %>% ggplot(aes(transmission, log_selling_price))+geom_boxplot(coef = 3)+geom_jitter(alpha=0.05)+theme(axis.text.x = element_text(angle = 0, hjust = 1))+stat_summary(fun.y=mean, geom="point", shape=20, size=3, color="red", fill="red")
corRatio(car$log_selling_price, car$transmission)
chisq_price_transmission <- chisq.test(car$log_selling_price, car$transmission, simulate.p.value = TRUE)
chisq_price_transmission$statistic
car %>% ggplot(aes(seller_type, log_selling_price))+geom_boxplot(coef = 3)+geom_jitter(alpha=0.05)+theme(axis.text.x = element_text(angle = 0, hjust = 1))+stat_summary(fun.y=mean, geom="point", shape=20, size=3, color="red", fill="red")
corRatio(car$log_selling_price, car$seller_type)
chisq_price_seller_type <- chisq.test(car$log_selling_price, car$seller_type, simulate.p.value = TRUE)
chisq_price_transmission$statistic
# Aggiorno il vettore delle colonne numeriche di car
car_nums_colnames_log <- c('log_age','log_selling_price','km_driven','log_engine_CC','log_max_power_bhp', 'seats')
# Prendo un campione di osservazioni per rendere più agile la rappresentazione grafica:
leggero <- car[sample(nrow(car), 500), ]
# Matrice dei diagrammi di dispersione: (non serve usare le variabili trasformate perchè la correlazione non cambia)
pairs(leggero[, car_nums_colnames_log])
cor(car[ ,car_nums_colnames_log])
ggcorr(car[,car_nums_colnames_log], label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
#T TEST
#Variable importance
#F TEST
#Adjusted R-squared                 quanto bene il modello descrive i dati
#Residual analysis
#(compare two models with anova)
#Prediction RMSE
car_dummy <- car[,car_nums_colnames_log]
car_dummy <- select(car_dummy, -c('seats', 'log_engine_CC', 'km_driven'))
# Aggiungo la variabile fattoriale 'transmission' a car dummy e la converto in numerica (0 corrispode a 'automatic'):
car_dummy <- cbind(car_dummy,transmission = car$transmission)
levels(car_dummy$transmission)<-c(1,0)
car_dummy$transmission <- as.numeric(levels(car_dummy$transmission))[car_dummy$transmission]
#converto la variabile fattoriale 'make' in dummy e la aggiungo a car_dummy:
dummy_temp <- data.frame(model.matrix( ~make, data = car))[,-1]
car_dummy <-cbind(car_dummy,dummy_temp)
#converto la variabile fattoriale 'fuel' in dummy e la aggiungo a car_dummy:
dummy_temp <- data.frame(model.matrix( ~fuel, data = car))[,-1]
car_dummy <-cbind(car_dummy,dummy_temp)
#converto la variabile fattoriale 'seller_type' in dummy e la aggiungo a car_dummy:
dummy_temp <- data.frame(model.matrix( ~seller_type, data = car))[,-1]
car_dummy <-cbind(car_dummy,dummy_temp)
#converto la variabile fattoriale 'owner' in dummy e la aggiungo a car_dummy:
dummy_temp <- data.frame(model.matrix( ~owner, data = car))[,-1]
car_dummy <-cbind(car_dummy,dummy_temp)
head(car_dummy)
sum(duplicated(car_dummy))
sum(duplicated(car))
car_dummy <- car_dummy[!duplicated(car_dummy),]
set.seed(100)
train_ind<-sample(1:nrow(car_dummy),0.8*nrow(car_dummy))
train_set <- car_dummy[train_ind,]
test_set <- car_dummy[-train_ind,]
print(paste("Numero righe train_set:", nrow(train_set), sep = " "))
print(paste("Numero righe test_set: ", nrow(test_set), sep = " "))
modello_completo <- lm(log_selling_price ~ ., data=train_set)
summary(modello_completo)
par(pty="s")
plot(modello_completo)
modello_minimo <- lm(log_selling_price ~ log_max_power_bhp, data=train_set)
summary(modello_minimo)
ggplot(train_set, aes(x = log_max_power_bhp, y = log_selling_price)) + geom_point() + stat_smooth(method = "lm", col = "red")
modello_stepAIC <- stepAIC(modello_minimo, direction = "forward", scope = formula(modello_completo))
summary(modello_stepAIC)
par(pty="s")
plot(modello_stepAIC)
k_value <- qchisq(0.001, 1, lower.tail = F)
modello_stepAIC_k <- stepAIC(modello_minimo, direction = "forward", scope = formula(modello_completo), k = k_value)
summary(modello_stepAIC_k)
par(pty="s")
plot(modello_stepAIC_k)
anova(modello_stepAIC, modello_stepAIC_k)
lm_pred <- predict(modello_stepAIC, newdata = test_set %>% select(-log_selling_price))
# RMSE of train dataset
RMSE(pred = modello_stepAIC$fitted.values, obs = train_set$log_selling_price)
# RMSE of test dataset
RMSE(pred = lm_pred, obs = test_set$log_selling_price)
######## qui valutazione dell'rmse del modello stepAIC k con meno variabili
lm_pred2 <- predict(modello_stepAIC_k, newdata = test_set %>% select(-log_selling_price))
# RMSE of train dataset
RMSE(pred = modello_stepAIC_k$fitted.values, obs = train_set$log_selling_price)
# RMSE of test dataset
RMSE(pred = lm_pred2, obs = test_set$log_selling_price)
ggcorr(modello_stepAIC, label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
plot(modello_stepAIC)
cor(modello_stepAIC)
ggcorr(modello_completo, label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
ggcorr(modello_completo, label = FALSE, label_size = 2.9, hjust = 1, layout.exp = 2)
ggcorr(modello_stepAIC_k, label = TRUE, label_size = 2.9, hjust = 1, layout.exp = 2)
vif(modello_stepAIC)
library(car)
vif(modello_stepAIC)
